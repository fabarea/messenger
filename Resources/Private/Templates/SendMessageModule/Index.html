<html
    data-namespace-typo3-fluid="true"
    xmlns:be="http://typo3.org/ns/TYPO3/CMS/Backend/ViewHelpers"
    xmlns:core="http://typo3.org/ns/TYPO3/CMS/Fluid/ViewHelpers"
    xmlns:f="http://typo3.org/ns/TYPO3/CMS/Fluid/ViewHelpers"
>
    <f:layout name="Default" />
    <f:section name="main">
        <h1>
            <f:translate
                key="LLL:EXT:messenger/Resources/Private/Language/tx_messenger_domain_model_sentmessage.xlf:mlang_labels_tablabel"
            />
        </h1>

        <div class="w-100">
            <f:if condition="{sortBy} && {direction}">
                <f:then>
                    <f:variable name="sortBy" value="{sortBy}" />
                    <f:variable name="direction" value="{direction}" />
                </f:then>
                <f:else>
                    <f:variable name="sortBy" value="crdate" />
                    <f:variable name="direction" value="asc" />
                </f:else>
            </f:if>

            <f:form
                action="index"
                arguments="{searchTerm: searchTerm, items: items}"
                class="w-100 row"
                controller="SendMessageModule"
                method="post"
            >
                <div class="d-flex gap-3 col-sm-10 mb-2">
                    <div class="w-100">
                        <f:form.textfield
                            class="form-control text-black"
                            name="searchTerm"
                            placeholder="Search..."
                            value="{searchTerm}"
                        />
                    </div>
                    <button class="btn btn-default" type="submit">
                        <core:icon identifier="actions-search" size="small" />
                    </button>
                </div>
                <div class="col-sm-2 col-menu-length w-[4%] d-flex gap-5">
                    <div class="w-75"></div>
                    <f:form.select
                        class="h-75 w-25 mt-10 text-black"
                        id="itemsPerPage"
                        name="items"
                        onclick="this.form.submit()"
                        prependOptionLabel="Please select number"
                        value="{itemsPerPages}"
                    >
                        <f:form.select.option value="20">20</f:form.select.option>
                        <f:form.select.option value="50">50</f:form.select.option>
                        <f:form.select.option value="100">100</f:form.select.option>
                        <f:form.select.option value="200">200</f:form.select.option>
                        <f:form.select.option value="500">500</f:form.select.option>
                        <f:form.select.option value="1000">1000</f:form.select.option>
                    </f:form.select>
                </div>
            </f:form>
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <f:variable name="color" value="text-black" />
                        <f:for as="selectedField" each="{selectedColumns}" iteration="iterator">
                            <f:if condition="{selectedField} != ''">
                                <th scope="col">
                                    <div class="d-flex">
                                        <div class="d-flex flex-column">
                                            <f:link.action
                                                action="index"
                                                arguments="{sortBy: '{selectedField}', direction: 'DESC', searchTerm: searchTerm,page: currentPage,items: itemsPerPages,selectedColumns: selectedColumns}"
                                                class="{f:if(condition: '{direction} == \'ASC\' && {sortBy} == {selectedField}', then: 'text-default', else: 'text-black-50')} text-decoration-none rounded"
                                                controller="SendMessageModule"
                                                id="sortByDesc"
                                            >
                                                <core:icon identifier="actions-caret-up" size="small" />
                                            </f:link.action>
                                            <f:link.action
                                                action="index"
                                                arguments="{sortBy: '{selectedField}', direction: 'ASC', searchTerm: searchTerm,page: currentPage,items: itemsPerPages,selectedColumns: selectedColumns}"
                                                class="{f:if(condition: '{direction} == \'DESC\' && {sortBy} == {selectedField}', then: 'text-default', else: 'text-black-50')} text-decoration-none rounded"
                                                controller="SendMessageModule"
                                                id="sortByAsc"
                                            >
                                                <core:icon identifier="actions-caret-down" size="small" />
                                            </f:link.action>
                                        </div>
                                        <div class="my-2">
                                            <f:translate
                                                key="LLL:EXT:messenger/Resources/Private/Language/tx_messenger_domain_model_sentmessage.xlf:{selectedField}"
                                            />
                                        </div>
                                    </div>
                                </th>
                            </f:if>
                        </f:for>
                    </tr>
                </thead>
                <tbody>
                    <f:for as="message" each="{paginator.paginatedItems }" iteration="iterator">
                        <tr>
                            <f:for as="selectedField" each="{selectedColumns}" iteration="selectedFieldIterator">
                                <f:if condition="{selectedField} != ''">
                                    <td>{message.{selectedField}}</td>
                                </f:if>
                            </f:for>
                            <td>
                                <div class="d-flex gap-3">
                                    <a
                                        class="btn btn-default"
                                        href="{be:uri.editRecord(uid: '{message.uid}', table:'tx_messenger_domain_model_sentmessage')}"
                                    >
                                        <core:icon identifier="actions-document-open" />
                                    </a>
                                    <f:variable
                                        name="deleteUrl"
                                        value="{be:moduleLink(route:'tce_db', query:'cmd[tx_messenger_domain_model_sentmessage][{message.uid}][delete]=1', currentUrlParameterName:'redirect')}"
                                    />
                                    <button
                                        class="btn btn-default"
                                        data-delete-url="{deleteUrl}"
                                        data-name="{message.sender}"
                                        onclick="return deleteItem(this)"
                                    >
                                        <core:icon identifier="actions-delete" size="small" />
                                    </button>
                                </div>
                            </td>
                        </tr>
                    </f:for>
                </tbody>
            </table>
            <f:if condition="{pagination}">
                <f:render arguments="{_all}" partial="Navigation/Navigation" />
            </f:if>
        </div>

        <script>
            function deleteItem(element) {
                console.log(element.dataset.name);
                return top.TYPO3.Modal.confirm(
                    'Delete',
                    'Are you sure to delete this message from ' + element.dataset.name + ' ?',
                    top.TYPO3.Severity.warning,
                )
                    .on('confirm.button.ok', function () {
                        window.location.href = element.dataset.deleteUrl;
                        top.TYPO3.Modal.currentModal.trigger('modal-dismiss');
                    })
                    .on('confirm.button.cancel', function () {
                        top.TYPO3.Modal.currentModal.trigger('modal-dismiss');
                    });
            }
        </script>
    </f:section>
</html>
